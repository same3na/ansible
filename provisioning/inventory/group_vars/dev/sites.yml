---

backend_docker_version: release-a1bdb90
swager_api_docker_version: release-a1bdb90
feature_app_docker_version: release-0124594
feature_app_server_docker_version: release-0124594
migrate_docker_version: release-a1bdb90
frontend_docker_version: release-e66d611


sites:
  - name: backend
    image: ghcr.io/same3na/backend:{{ backend_docker_version }}
    env:
      PORT: "8000"
      BASE_URL: "http://backend-app:8000"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      DBHOST: "host.containers.internal"
      DBPORT: "5432"
      DBNAME: "same3na"
      DBUSER: "same3nauser"
      DBPASS: "{{ vault.db.same3na_password }}"
      SSLMODE: "disable"
      ALLOWED_ORIGINS: "*"
      FEATURES_SERVER_URL: "http://features-app-server:8881"
    labels:
      traefik.enable: "true"
      traefik.http.routers.backend.rule: "Host(`api.{{ base_url }}`)"
      traefik.http.services.backend.loadbalancer.server.port: "8000"
      traefik.http.routers.backend.entrypoints: "websecure"
      traefik.http.routers.backend.tls.certresolver: "myresolver"

  - name: swagger-api
    image: ghcr.io/same3na/backend-swagger:{{ swager_api_docker_version }}
    labels:
      traefik.enable: "true"
      traefik.http.routers.backend-swagger.rule: "Host(`swagger.{{ base_url }}`)"
      traefik.http.services.backend-swagger.loadbalancer.server.port: "8080"
      traefik.http.routers.backend-swagger.entrypoints: "websecure"
      traefik.http.routers.backend-swagger.tls.certresolver: "myresolver"
  
  - name: features-app-server
    image: ghcr.io/same3na/features-app-server:{{ feature_app_server_docker_version }}
    env:
      DBUSER: "same3nauser"
      DBNAME: "same3na"
      DBPASS: "{{ vault.db.same3na_password }}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      PYTHONPATH: "src"
      DBPORT: "5432"
      REDIS_DB: "0"
      DBHOST: "host.containers.internal"
      SSLMODE: "disable"
    volumes:
      - /home/same3na/youtube_cookies.txt:/app/src/cookies.txt

  - name: features-app
    image: ghcr.io/same3na/features-app:{{ feature_app_docker_version }}
    env:
      DBUSER: "same3nauser"
      DBNAME: "same3na"
      DBPASS: "{{ vault.db.same3na_password }}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      PYTHONPATH: "src"
      DBPORT: "5432"
      REDIS_DB: "0"
      DBHOST: "host.containers.internal"
      SSLMODE: "disable"
    volumes:
      - /home/same3na/youtube_cookies.txt:/app/src/cookies.txt
      
  - name: frontend
    image: ghcr.io/same3na/spa:{{ frontend_docker_version }}
    labels:
      traefik.enable: "true"
      traefik.http.routers.frontend.rule: "Host(`{{ base_url }}`)"
      traefik.http.services.frontend.loadbalancer.server.port: "80"
      traefik.http.routers.frontend.entrypoints: "websecure"
      traefik.http.routers.frontend.tls.certresolver: "myresolver"

  # - name: migrate
  #   image: ghcr.io/same3na/migrations:{{ migrate_docker_version }}
  #   command: ["./wait-for-it.sh", "host.containers.internal:5432", "--", "alembic", "upgrade", "head"]
  #   env:
  #     DB_HOST: "host.containers.internal"
  #     DB_NAME: "same3na"
  #     DB_USER: "same3nauser"
  #     DB_PASS: "{{ vault.db.same3na_password }}"
